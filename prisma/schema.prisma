generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Global Settings
model Settings {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  seq             Int      @default(autoincrement())
  applicationName String   @map("application_name")
  homeDirectory   String   @map("home_directory")
  /// Refresh interval in milliseconds
  pollingInterval Int      @default(30000) @map("polling_interval")
  active          Boolean  @default(true)
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(3)

  @@map("settings")
}

model User {
  id           String       @id(map: "user_pkey") @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  seq          Int          @default(autoincrement())
  email        String       @unique(map: "user_email_key") @db.VarChar(255)
  role         UserRole     @default(USER)
  name         String       @db.VarChar(100)
  nickname     String       @db.VarChar(50)
  workFunction WorkFunction @map("work_function")
  passwordHash String       @map("password_hash") @db.VarChar(255)
  active       Boolean      @default(true)
  createdAt    DateTime     @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt    DateTime     @updatedAt @map("updated_at") @db.Timestamptz(3)
  events       Event[]
  messages     Message[]
  profile      Profile?

  @@map("login")
}

model Organization {
  id          String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  seq         Int                   @default(autoincrement())
  name        String
  description String?
  active      Boolean               @default(true)
  createdAt   DateTime              @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt   DateTime              @updatedAt @map("updated_at") @db.Timestamptz(3)
  artifacts   Artifact[]
  cisControls OrganizationCisControl[]
  events      Event[]
  settings    OrganisationSettings?
  profiles    Profile[]
  tasks       Task[]

  @@map("organization")
}

model OrganisationSettings {
  id                String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  seq               Int          @default(autoincrement())
  organizationId    String       @unique @map("organization_id") @db.Uuid
  uploadDirectory   String       @map("upload_directory")
  downloadDirectory String       @map("download_directory")
  artifactDirectory String       @map("artifact_directory")
  active            Boolean      @default(true)
  createdAt         DateTime     @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt         DateTime     @updatedAt @map("updated_at") @db.Timestamptz(3)
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@map("organization_settings")
}

/// Note.
///         * Profiles can be detached from Organization (organizationId can be null)
///         * organizationId holds the relation to Oranization (Profile 1<->MANY Organization)
///         * currentOrganizationId is the current selected Organization. Not the only Organizaion the Profile may have access to
model Profile {
  id                    String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  seq                   Int           @default(autoincrement())
  currentOrganizationId String?       @map("current_organization_id") @db.Uuid
  organizationId        String?       @map("organization_id") @db.Uuid
  userId                String        @unique @map("user_id") @db.Uuid
  name                  String
  description           String?
  active                Boolean       @default(true)
  createdAt             DateTime      @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt             DateTime      @updatedAt @map("updated_at") @db.Timestamptz(3)
  events                Event[]
  organization          Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user                  User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  taskProfiles          TaskProfile[]

  @@index([organizationId])
  @@index([userId])
  @@map("profile")
}

/// An Artifact belongs to an Organization. Can be associated with zero or more Tasks (under the same Organization)
///    
///    size is of type String, since BigInt was too much hazzle to work with.
model Artifact {
  id             String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  seq            Int            @default(autoincrement())
  organizationId String         @map("organization_id") @db.Uuid
  name           String
  description    String?
  type           ArtifactType
  mimeType       String?        @map("mime_type")
  extension      String?
  size           String?        @map("size")
  originalName   String?        @map("original_name")
  active         Boolean        @default(true)
  createdAt      DateTime       @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt      DateTime       @updatedAt @map("updated_at") @db.Timestamptz(3)
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  events         Event[]
  taskArtifacts  TaskArtifact[]

  @@index([organizationId])
  @@map("artifact")
}

/// Note. Tasks can be detached from Organization (organizationId can be null)
model Task {
  id               String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  seq              Int            @default(autoincrement())
  organizationId   String?        @map("organization_id") @db.Uuid
  name             String
  description      String?
  expectedEvidence String?        @map("expected_evidence")
  startAt          DateTime?      @map("start_at") @db.Timestamptz(3)
  endAt            DateTime?      @map("end_at") @db.Timestamptz(3)
  status           TaskStatus     @default(NOT_STARTED)
  active           Boolean        @default(true)
  createdAt        DateTime       @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt        DateTime       @updatedAt @map("updated_at") @db.Timestamptz(3)
  events           Event[]
  messages         Message[]
  organization     Organization?  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  taskArtifacts    TaskArtifact[]
  taskProfiles     TaskProfile[]
  taskSafeguards   TaskSafeguard[]

  @@index([organizationId])
  @@index([startAt])
  @@index([endAt])
  @@map("task")
}

model TaskProfile {
  taskId    String   @map("task_id") @db.Uuid
  profileId String   @map("profile_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  profile   Profile  @relation(fields: [profileId], references: [id])
  task      Task     @relation(fields: [taskId], references: [id])

  @@id([taskId, profileId])
  @@index([taskId])
  @@index([profileId])
  @@map("task_profile")
}

model TaskArtifact {
  taskId     String   @map("task_id") @db.Uuid
  artifactId String   @map("artifact_id") @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at")
  artifact   Artifact @relation(fields: [artifactId], references: [id])
  task       Task     @relation(fields: [taskId], references: [id])

  @@id([taskId, artifactId])
  @@index([taskId])
  @@index([artifactId])
  @@map("task_artifact")
}

/// Tracks which CIS 18 Controls are active/inactive per Organization.
/// controlId is 1â€“18 matching the CIS v8 control numbers.
model OrganizationCisControl {
  organizationId String       @map("organization_id") @db.Uuid
  controlId      Int          @map("control_id")
  active         Boolean      @default(true)
  createdAt      DateTime     @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt      DateTime     @updatedAt @map("updated_at") @db.Timestamptz(3)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@id([organizationId, controlId])
  @@index([organizationId])
  @@map("organization_cis_control")
}

/// Links a Task to a CIS Safeguard (e.g. "1.1", "3.4"). Safeguards are defined in code, not in DB.
model TaskSafeguard {
  taskId      String   @map("task_id") @db.Uuid
  safeguardId String   @map("safeguard_id") @db.VarChar(10)
  createdAt   DateTime @default(now()) @map("created_at")
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@id([taskId, safeguardId])
  @@index([taskId])
  @@index([safeguardId])
  @@map("task_safeguard")
}

/// Messages tied to Tasks - can be system-generated or from users
model Message {
  id        String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  seq       Int         @default(autoincrement())
  taskId    String      @map("task_id") @db.Uuid
  /// If type is USER, senderId should be set. If SYSTEM, it can be null
  senderId  String?     @map("sender_id") @db.Uuid
  type      MessageType @default(USER)
  content   String
  isRead    Boolean     @default(false) @map("is_read")
  active    Boolean     @default(true)
  createdAt DateTime    @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt DateTime    @updatedAt @map("updated_at") @db.Timestamptz(3)
  sender    User?       @relation(fields: [senderId], references: [id])
  task      Task        @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([senderId])
  @@index([isRead])
  @@index([createdAt])
  @@map("message")
}

/// Event/Audit Log - Tracks actions across different entities
model Event {
  id             String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  seq            Int              @default(autoincrement())
  /// User who initiated the action (null if system-generated)
  userId         String?          @map("user_id") @db.Uuid
  /// The event can be attached to one of these entities
  organizationId String?          @map("organization_id") @db.Uuid
  taskId         String?          @map("task_id") @db.Uuid
  profileId      String?          @map("profile_id") @db.Uuid
  artifactId     String?          @map("artifact_id") @db.Uuid
  importance     EventImportance?
  message        String
  active         Boolean          @default(true)
  createdAt      DateTime         @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt      DateTime         @updatedAt @map("updated_at") @db.Timestamptz(3)
  artifact       Artifact?        @relation(fields: [artifactId], references: [id], onDelete: Cascade)
  organization   Organization?    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  profile        Profile?         @relation(fields: [profileId], references: [id], onDelete: Cascade)
  task           Task?            @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user           User?            @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([organizationId])
  @@index([taskId])
  @@index([profileId])
  @@index([artifactId])
  @@index([createdAt])
  @@map("event")
}

enum WorkFunction {
  DEVELOPER
  DESIGNER
  PRODUCT_MANAGER
  MARKETING
  SALES
  HR
  FINANCE
  OPERATIONS
  EXECUTIVE
  OTHER
}

enum UserRole {
  USER
  /// Admin of Organisations.
  ADMIN
  /// Compliance-Circle Admin. Can create/delete Organisations.
  SUPER_ADMIN
}

enum TaskStatus {
  NOT_STARTED
  OPEN
  COMPLETED
  /// Stopped without completing
  CLOSED
}

enum ArtifactType {
  /// PDF, DOC, DOCX, TXT
  DOCUMENT
  /// XLS, XLSX, CSV
  EXCEL
  /// PNG, JPG, JPEG, SVG
  IMAGE
  /// PPT / PPTX / PDF slides
  PRESENTATION
  /// PDF
  PDF
  /// Contracts, Policies, Terms & conditions, Legal statements
  CONTRACT
  LEGAL
  POLICY
  PROCEDURE
  /// Risk reports, Audit reports, Management reports
  REPORT
  /// MP4, MOV, WEBM
  VIDEO
  /// interviews or incident logs
  AUDIO
  /// ZIPs, bundles, exported data.
  ARCHIVE
  /// JSON, XML, CSV (if not Excel)
  DATA
  SOURCE_CODE
  OTHER
}

enum MessageType {
  /// System-generated message
  SYSTEM
  /// Message from a user
  USER
}

enum EventImportance {
  LOW
  MIDDLE
  HIGH
}
